flatt-functions Implementation Plan – Technical Summary

Overview
- Stack: Azure Functions (dotnet-isolated, .NET 8)
- Hosting: Azure Functions with anonymous HTTP triggers; one queue processor
- Config: IConfiguration injected from host; values sourced from Azure App Settings / local.settings.json
- Telemetry: Application Insights (worker service)

Configuration & Environment Variables
- FUNCTIONS_WORKER_RUNTIME: dotnet-isolated
- AzureWebJobsSecretStorageType: Files (local dev)
- AzureWebJobsStorage: Storage account connection string (host runtime)
- SqlConnectionString: Primary SQL DB connection (Azure SQL)
- StorageConnection: General storage connection (redundant with AzureWebJobsStorage)
- BlobConnectionString: Blob storage connection
- BlobBaseURL: Base URL for blob images
- Blob_URL: Alias for BlobBaseURL used in code
- BlobContainerName: Expected by code for container name (not present in local.settings.json)
- BlobPathPrefix: Expected path prefix (not present in local.settings.json)
- ImageQuality: JPEG/WebP quality setting (e.g., 85)
- DisableEmailService: Feature flag to disable outbound email
- EmailConnectionString: Email provider connection
- EmailFrom: Default sender address (DoNotReply@IceCastleUSA.com)
- SalesEmail: Destination for inquiries (Austin@Fuhrent.com)
- InquiryQueueName: Name of inquiries queue (disabled-queue-dev for local)
- InquiryQueueURL: Queue URL (optional; empty in local)

How Configuration Is Accessed
- All functions accept `IConfiguration` via DI. Values are read with `configuration.GetConnectionString("<Name>")`.
- The project relies on ConnectionStrings section naming even for non-connection string keys; ensure Azure App Settings include these keys in ConnectionStrings or switch to `configuration["Key"]` consistently.
- Program.cs wires configuration and Application Insights.

Functions and Routes
- AddInventory: POST /vehicles/add
  Purpose: Insert vehicle record and associated images into SQL + Blob
  Depends: SqlConnectionString, BlobConnectionString, BlobBaseURL, Blob_URL, BlobContainerName, BlobPathPrefix

- DeleteInventory: DELETE or GET /vehicles/delete/{id}
  Purpose: Remove vehicle and associated blobs
  Depends: SqlConnectionString, BlobConnectionString, BlobBaseURL, Blob_URL, BlobContainerName, BlobPathPrefix

- GetById: GET /vehicles/{id}
  Purpose: Retrieve vehicle details by ID from SQL
  Depends: SqlConnectionString

- GetDashboardStats: GET /dashboard/stats
  Purpose: Aggregate stats for admin/dashboard
  Depends: SqlConnectionString

- GetFeatures: GET /features
  Purpose: List all feature tags/options
  Depends: SqlConnectionString

- GetReportsDashboard: GET /reports/dashboard
  Purpose: Reporting dataset for dashboard views
  Depends: SqlConnectionString

- GetAllUnitFeatures: GET /unit-features
  Purpose: Fetch all unit features across inventory
  Depends: SqlConnectionString

- GetUnitFeaturesForUnit: GET /units/{id:int}/features
  Purpose: Fetch features for a specific unit
  Depends: SqlConnectionString

- Images (multiple endpoints):
  - GET /units/{id:int}/images
    Purpose: List images for unit
    Depends: SqlConnectionString
  - GET /units/{id:int}/images/{name}
    Purpose: Fetch image metadata or content reference
    Depends: BlobBaseURL, Blob_URL
  - POST /units/{id:int}/images
    Purpose: Upload/add images
    Depends: BlobConnectionString, BlobContainerName, BlobPathPrefix, ImageQuality
  - DELETE /units/{id:int}/images/{name}
    Purpose: Delete image
    Depends: BlobConnectionString, BlobContainerName, BlobPathPrefix
  - PUT /units/{id:int}/images/{oldName}/rename/{newName}
    Purpose: Rename image
    Depends: BlobConnectionString, BlobContainerName, BlobPathPrefix

- CheckDb: GET /checkdb
  Purpose: Health check for DB connectivity
  Depends: SqlConnectionString

- CheckStatus: GET /checkstatus/{id}
  Purpose: Status lookup for unit
  Depends: SqlConnectionString

- CheckVin: GET /checkvin/{vin}
  Purpose: VIN validation/lookup
  Depends: SqlConnectionString (and any external VIN APIs if present; none detected)

- GrabInventoryAll: GET (no route specified beyond default) – returns HTML summary
  Purpose: Dump inventory table with schema info and timing
  Depends: SqlConnectionString

- GrabInventoryFH: GET – HTML summary for `fh` table
  Purpose: Inventory dump for FH table
  Depends: SqlConnectionString

- GrabInventoryVH: GET – HTML summary for `vh` table
  Purpose: Inventory dump for VH table
  Depends: SqlConnectionString

- PurgeCdnCache: POST /cdn/purge
  Purpose: Purge CDN cache entries (likely calls CDN endpoint via HttpClient)
  Depends: HttpClient; may require CDN credentials in future

- SendInquiry: POST /inquiries
  Purpose: Accept inquiries and enqueue/process
  Depends: DisableEmailService, EmailConnectionString, EmailFrom, SalesEmail, InquiryQueueName, InquiryQueueURL, Storage/Azure Queue

- ProcessInquiryQueue: Queue processor (trigger inferred; class present)
  Purpose: Dequeue inquiries, compose and send email, handle retries
  Depends: EmailConnectionString, EmailFrom, SalesEmail; Blob/Storage if attachments; handles 429/503 with retry

Security & Abuse Limiting
- AuthorizationLevel: All HTTP endpoints are Anonymous; enforce upstream (APIM, Frontend) authentication/authorization if needed.
- Rate limiting: No explicit rate limiting in code. Consider implementing per-IP throttling via APIM policies or a middleware gateway.
- Validation: Functions parse route parameters; ensure input validation for IDs, VINs, and image names. Review AddInventory/Images for sanitization of filenames and schema constraints.
- 429 handling: ProcessInquiryQueue catches `RequestFailedException` on 429/503 and likely retries with backoff.
- CORS: Host setting allows "*" for dev; tighten in production.
- Secrets: Current local.settings.json contains real keys; remove from repo and store in Azure App Settings / Key Vault.

Operational Notes
- Build/Run: dotnet build; Azure Functions host via `func host start` (task wired in workspace)
- Telemetry: Application Insights configured; ensure instrumentation key/connection string is set by platform
- Storage: Uses both `AzureWebJobsStorage` (runtime) and `BlobConnectionString` (app logic); keep consistent
- Images: Uses Blob container paths; ensure `BlobContainerName` and `BlobPathPrefix` are set in App Settings
- Email: Toggle via `DisableEmailService`; ensure provider connection string

Recommended Azure App Settings (Production)
- In ConnectionStrings:
  - SqlConnectionString
  - BlobConnectionString
- In App Settings (non-connection):
  - BlobBaseURL
  - Blob_URL (or consolidate to one key)
  - BlobContainerName
  - BlobPathPrefix
  - ImageQuality
  - DisableEmailService
  - EmailConnectionString
  - EmailFrom
  - SalesEmail
  - InquiryQueueName
  - InquiryQueueURL
  - FUNCTIONS_WORKER_RUNTIME
- Platform:
  - AzureWebJobsStorage (runtime)
  - ApplicationInsightsConnectionString

External Integrations
- Azure Storage (Blobs, Queues)
- Azure SQL Database
- CDN purge via HTTP endpoint (details TBD)

Testing & Observability
- Health endpoints: /checkdb, /checkstatus/{id}, /checkvin/{vin}
- HTML dumps: GrabInventory* endpoints return schema and processing times
- Application Insights logs/metrics enabled

Action Items
- Remove secrets from repo; use Key Vault/App Settings
- Add APIM or Front Door with rate limiting and JWT-based auth for sensitive endpoints (Add/Delete/Images POST/DELETE/PUT)
- Consolidate Blob URL keys; ensure all required blob config keys exist in production settings
- Add request validation and size limits for image uploads
- Add anti-spam checks for SendInquiry (captcha or rate limit per IP/email)
- Document expected schemas for inventory tables (FH/VH)
